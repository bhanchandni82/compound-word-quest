<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compound Quest: Evolution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background: #0f172a; 
            color: white; 
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; 
            overflow-x: hidden; 
            touch-action: manipulation; 
        }
        .word-btn { 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            cursor: pointer; 
            user-select: none; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 60px; 
            text-align: center; 
            padding: 8px; 
            font-weight: bold; 
            border-radius: 1rem;
            text-transform: uppercase;
        }
        .selected { 
            background-color: #4f46e5 !important; 
            border-color: #818cf8 !important; 
            transform: scale(1.05); 
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.6);
        }
        .shake { animation: shake 0.4s; }
        @keyframes shake { 
            0%, 100% { transform: translateX(0); } 
            25% { transform: translateX(-8px); border-color: #ef4444; } 
            75% { transform: translateX(8px); border-color: #ef4444; } 
        }
        .bubble {
            position: absolute;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s, scale 0.3s;
            box-shadow: inset 0 0 20px rgba(255,255,255,0.2), 0 4px 10px rgba(0,0,0,0.3);
            border: 4px solid rgba(255,255,255,0.2);
            font-size: 0.85rem;
            padding: 12px;
            text-align: center;
            word-break: break-word;
            touch-action: none;
            z-index: 20;
            user-select: none;
        }
        .bubble.active-selection {
            animation: bubblePulse 1s infinite alternate;
            border-color: #fbbf24;
            box-shadow: 0 0 20px #fbbf24;
        }
        @keyframes bubblePulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        
        .found-tag {
            animation: tagPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: #16a34a;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: bold;
            border: 1px solid rgba(74, 222, 128, 0.3);
            white-space: nowrap;
        }
        @keyframes tagPop {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="flex flex-col items-center p-4 min-h-screen">
    <div class="w-full max-w-md flex justify-between items-center mb-4 bg-slate-800 p-4 rounded-2xl border border-slate-700 shadow-xl relative">
        <div class="text-center">
            <span class="text-[10px] text-slate-400 block uppercase font-bold tracking-widest">Level</span>
            <span id="level-display" class="text-xl font-black text-indigo-400">1/-</span>
        </div>
        <div class="text-center">
            <span class="text-[10px] text-slate-400 block uppercase font-bold tracking-widest">Score</span>
            <span id="score-display" class="text-xl font-black text-yellow-400">0</span>
        </div>
        <div class="flex items-center gap-3">
             <button onclick="toggleSettings()" class="bg-slate-700 p-2 rounded-lg text-slate-300 hover:bg-slate-600 transition-colors">‚öôÔ∏è</button>
        </div>
    </div>

    <div class="w-full max-w-md flex justify-between items-center px-2 mb-2">
        <span id="mode-display" class="text-[10px] text-indigo-400 font-bold uppercase tracking-widest">LOADING...</span>
        <div class="w-32 h-2 bg-slate-700 rounded-full overflow-hidden">
            <div id="progress-bar" class="h-full bg-indigo-500 w-0 transition-all duration-300"></div>
        </div>
    </div>

    <div id="instruction-bar" class="w-full max-w-md py-3 mb-4 bg-slate-700/50 rounded-xl text-center text-xs font-bold text-slate-300 italic">Master the compounds!</div>

    <div id="game-viewport" class="relative w-full max-w-md bg-slate-900/50 rounded-3xl border border-slate-800 overflow-hidden min-h-[450px]">
        
        <!-- Global Found Words List -->
        <div id="found-words-list" class="bg-indigo-900/40 p-2 flex flex-wrap gap-1.5 justify-center border-b border-indigo-500/20 min-h-[45px] transition-all"></div>

        <div id="match-container" class="grid grid-cols-2 gap-4 p-4 hidden">
            <div id="left-col" class="flex flex-col gap-3"></div>
            <div id="right-col" class="flex flex-col gap-3"></div>
        </div>
        
        <div id="bubble-container" class="absolute inset-0 hidden flex flex-col">
            <div id="bubble-arena" class="relative flex-grow"></div>
        </div>

        <div id="grid-container" class="grid grid-cols-3 gap-2 p-4 hidden"></div>
    </div>

    <div id="meaning-box" class="w-full max-w-md mt-6 p-4 bg-indigo-900/30 border border-indigo-500/30 rounded-2xl opacity-0 transition-all duration-200 text-center shadow-lg">
        <p id="word-title" class="text-indigo-300 font-bold uppercase text-sm mb-1 tracking-widest"></p>
        <p id="word-meaning" class="text-slate-200 text-sm italic"></p>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-slate-950/80 hidden z-[60] flex items-center justify-center p-6">
        <div class="bg-slate-800 p-6 rounded-3xl w-full max-w-xs border border-slate-700">
            <h3 class="text-xl font-bold mb-4 text-center">Settings</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center"><span>Mute Sounds</span><input type="checkbox" id="mute-toggle" class="w-6 h-6"></div>
                <div class="flex justify-between items-center"><span>Calm Mode</span><input type="checkbox" id="calm-toggle" class="w-6 h-6"></div>
                <button onclick="toggleSettings()" class="w-full bg-indigo-600 py-3 rounded-xl font-bold mt-4">Close</button>
            </div>
        </div>
    </div>

    <div id="overlay" class="fixed inset-0 bg-slate-950/90 flex items-center justify-center hidden z-50 p-6">
        <div class="bg-slate-800 p-8 rounded-3xl text-center max-w-xs w-full border border-indigo-500/30 shadow-2xl">
            <div class="text-6xl mb-4">üåü</div>
            <h2 class="text-2xl font-black mb-2 text-white">Awesome!</h2>
            <p class="text-slate-400 mb-6">Level <span id="completed-lvl">1</span> Complete!</p>
            <button onclick="startNextLevel()" class="w-full bg-indigo-600 hover:bg-indigo-500 py-4 rounded-xl font-bold text-lg shadow-lg">Next Level üöÄ</button>
        </div>
    </div>

    <script>
        const rawCSVData = `DO,NATION\nSLIT,HER\nCAR,GO\nCOMB,AT\nFOR,MAT\nFOR,BID\nRAM,PAGE\nHIGH,BALL\nHAND,SOME\nAN,OTHER\nPOWER,LESS\nCENT,RALLY\nCAN,ON\nAIR,LINE\nCAR,PET\nTAR,GET\nFOR,TUNE\nPART,RIDGE\nCART,RIDGE\nKNOW,LEDGE\nOUT,LET\nACT,OR\nFORE,CAST\nOR,DEAL\nTRIP,LET\nFACT,OR\nTURN,COAT\nWATER,FALL\nSO,LID\nSEED,LING\nEAR,WIG\nAS,CENT\nPAGE,ANT\nSTIR,RING\nAT,TACK\nIN,SCRIBE\nBUTTER,CUP\nSAT,URN\nPASS,AGE\nJUST,ICE\nUP,HOLD\nAM,BUSH\nWAG,ON\nOUT,PUT\nBAND,IT\nTO,WING\nDEAD,LOCK\nRAN,SACK\nPORT,ABLE\nNO,VICE\nFEAT,HER\nHEAT,HER\nHUM,AN\nCOT,TON\nSNAP,PING\nBAR,GAIN\nFUR,ROW\nCAB,IN\nPUFF,IN\nRAIL,WAY\nBAR,ROW\nDAM,AGE\nA,VOID\nA,WAY\nTRAP,DOOR\nWEEK,END\nNOT,ICE\nCART,ON\nBE,AT\nME,AN\nBE,HIND\nTAB,LET\nBAT,ON\nBUT,TON\nMAN,AGE\nCAR,CASE\nCAP,ABLE\nQUEST,ION\nBIRTH,DAY\nFOR,GET\nCAR,ROT\nIN,CREASE\nMAY,OR\nPULL,OVER\nOR,BIT\nPRIM,ROSE\nNAP,KIN\nAS,KING\nFORT,NIGHT\nBIT,TEN\nFRIEND,SHIP\nREST,LESS\nHER,ON\nBAND,AGE\nFOR,WARD\nIS,LAND\nROT,TEN\nOVER,WEIGHT\nPOST,AGE\nADAPT,ABLE\nKEY,BOARD\nCARE,TAKER\nCUP,BOARD\nEYE,BALL\nREST,RAIN\nMAN,HOLE\nOVER,ACT\nSIDE,BOARD\nCOPY,RIGHT\nNO,BODY\nNOW,HERE\nRUN,AWAY\nOFF,SPRING\nOUT,LAW\nUNDER,GROWTH\nSOME,ONE\nWHAT,EVER\nUNDER,TAKE\nOVER,COAT\nSUN,BURN\nUP,ON\nOUT,BURST\nVIEW,POINT\nSTY,LED\nEVER,GREEN\nDATA,BASE\nDOWN,LOAD\nBROAD,BAND\nOVER,DUE\nPASS,PORT\nPIN,STRIPE\nYOUR,SELF\nWE,ATHER\nHEAD,LAND\nHEART,ACHE\nHOME,MADE\nHEART,BEAT\nHONEY,COMB\nBOOK,MARK\nFIRE,PLACE\nWATER,FALL\nBUTTER,FLY\nARM,CHAIR\nAFTER,NOON\nBATH,ROOM\nBACK,BONE\nBACK,GROUND\nBACK,WARD\nBED,TIME\nBLUE,BELL\nBOOK,CASE\nCAMP,FIRE\nCANDLE,STICK\nDISH,WASHER\nDOG,HOUSE\nDOWN,STAIRS\nDRAGON,FLY\nDRESS,MAKER\nEAR,RING\nEVERY,BODY\nEVERY,THING\nFARM,HOUSE\nFOOT,BALL\nFOOT,PRINT\nGOLD,FISH\nGRAND,FATHER\nGRAND,MOTHER\nGRASS,HOPPER\nGROUND,WORK\nHAIR,CUT\nHAND,BAG\nHAND,WRITING\nHEAD,ACHE\nHEAD,LIGHT\nHOME,WORK\nHORSE,BACK\nHOUSE,HOLD\nHOUSE,WORK\nIN,SIDE\nJELLY,FISH\nLADY,BIRD\nLIFE,BOAT\nLIGHT,HOUSE\nLIP,STICK\nMID,NIGHT\nMOTOR,WAY\nNAME,PLATE\nNEWS,PAPER\nNIGHT,MARE\nOUT,SIDE\nOVER,TAKE\nPAN,CAKE\nPAPER,BACK\nPLAY,GROUND\nPOLICE,MAN\nPOST,MAN\nRAIN,BOW\nRAIN,COAT\nRIVER,SIDE\nROAD,SIDE\nSAIL,BOAT\nSAND,CASTLE\nSCARE,CROW\nSCHOOL,BOY\nSCHOOL,GIRL\nSEA,SIDE\nSHIP,WRECK\nSHOP,KEEPER\nSKATE,BOARD\nSNOW,BALL\nSNOW,MAN\nSOME,BODY\nSOMETIMES\nSOMEWHERE\nSOUND,PROOF\nSPACE,SHIP\nSTAIR,CASE\nSTAR,FISH\nSTEAM,BOAT\nSUN,FLOWER\nSUN,GLASSES\nSUN,LIGHT\nSUN,SET\nSUN,SHINE\nTABLE,CLOTH\nTABLE,SPOON\nTEA,POT\nTHUNDER,STORM\nTIME,TABLE\nTOOTH,BRUSH\nTOOTH,PASTE\nUP,STAIRS\nWALL,PAPER\nWASH,ROOM\nWATCH,MAN\nWATER,COLOR\nWATER,PROOF\nWHEEL,CHAIR\nWOOD,LAND`;

        const AudioEngine = {
            ctx: null, streak: 0, consecutiveErrors: 0,
            init() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            getRandomPitch(freq) { return freq + (Math.random() * freq * 0.1 - freq * 0.05); },
            getVolume(baseVol = 0.2) {
                if (document.getElementById('mute-toggle').checked) return 0;
                let vol = baseVol;
                if (this.consecutiveErrors >= 3) vol *= 0.5;
                if (document.getElementById('calm-toggle').checked) vol *= 0.6;
                return vol;
            },
            playNote(freq, type = 'triangle', duration = 0.2, volume = 0.2) {
                if (!this.ctx) this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(this.getRandomPitch(freq), this.ctx.currentTime);
                gain.gain.setValueAtTime(volume, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            },
            correct() { this.consecutiveErrors = 0; this.streak++; const vol = this.getVolume(0.15); this.playNote(523.25, 'triangle', 0.15, vol); setTimeout(() => this.playNote(659.25, 'triangle', 0.25, vol), 80); },
            wrong() { this.streak = 0; this.consecutiveErrors++; this.playNote(110, 'sine', 0.3, this.getVolume(0.1)); },
            pop() { this.playNote(800, 'sine', 0.05, this.getVolume(0.1)); },
            levelComplete() { const vol = this.getVolume(0.2); [523, 659, 783, 1046].forEach((f, i) => setTimeout(() => this.playNote(f, 'square', 0.3, vol), i * 150)); },
            tap() { this.playNote(400, 'triangle', 0.05, this.getVolume(0.05)); }
        };

        let masterWordList = [];
        let currentLevel = 1;
        let score = 0;
        let levelWords = [];
        let isProcessing = false;
        
        // Removed FALLING mode
        let gameModeSequence = ['MATCH', 'BUBBLE', 'GRID']; 

        function processCSV() {
            const lines = rawCSVData.split('\n');
            masterWordList = lines.map(line => {
                const [p, s] = line.split(',');
                return { p, s, full: p + s, m: "A compound word." };
            });
            masterWordList.sort(() => Math.random() - 0.5);
        }

        function getUniqueWordsForLevel(count) {
            const levelSet = [];
            const usedPrefixes = new Set();
            const usedSuffixes = new Set();
            const startOffset = Math.floor(Math.random() * masterWordList.length);
            
            for (let i = 0; i < masterWordList.length; i++) {
                const idx = (startOffset + i) % masterWordList.length;
                const word = masterWordList[idx];
                if (!usedPrefixes.has(word.p) && !usedSuffixes.has(word.s)) {
                    levelSet.push(word);
                    usedPrefixes.add(word.p);
                    usedSuffixes.add(word.s);
                }
                if (levelSet.length >= count) break;
            }
            return levelSet;
        }

        function setupLevel() {
            levelWords = getUniqueWordsForLevel(5);
            
            document.getElementById('level-display').textContent = currentLevel;
            document.getElementById('meaning-box').style.opacity = '0';
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('found-words-list').innerHTML = '';
            
            const modeIndex = (currentLevel - 1) % gameModeSequence.length;
            const currentMode = gameModeSequence[modeIndex];
            document.getElementById('mode-display').textContent = currentMode + " MODE";
            
            ['match-container', 'bubble-container', 'grid-container'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            
            if (currentMode === 'BUBBLE') initBubbleMode();
            else if (currentMode === 'MATCH') initMatchMode();
            else if (currentMode === 'GRID') initGridMode();
        }

        function addToFoundList(word) {
            const shelf = document.getElementById('found-words-list');
            const tag = document.createElement('span');
            tag.className = 'found-tag';
            tag.textContent = word;
            shelf.appendChild(tag);
        }

        function initMatchMode() {
            const container = document.getElementById('match-container');
            const leftCol = document.getElementById('left-col');
            const rightCol = document.getElementById('right-col');
            container.classList.remove('hidden');
            leftCol.innerHTML = ''; rightCol.innerHTML = '';
            
            let matchCount = 0;
            let selectedPre = null;
            const prefixes = [...levelWords].sort(() => Math.random() - 0.5);
            const suffixes = [...levelWords].sort(() => Math.random() - 0.5);

            prefixes.forEach(w => {
                const btn = document.createElement('div');
                btn.className = 'word-btn bg-slate-800 border-2 border-slate-700';
                btn.textContent = w.p;
                btn.onclick = () => {
                    if (btn.classList.contains('bg-green-600') || isProcessing) return;
                    AudioEngine.tap();
                    if (selectedPre) selectedPre.classList.remove('selected');
                    selectedPre = btn; btn.classList.add('selected');
                };
                leftCol.appendChild(btn);
                btn.dataset.id = w.full;
            });

            suffixes.forEach(w => {
                const btn = document.createElement('div');
                btn.className = 'word-btn bg-slate-800 border-2 border-slate-700';
                btn.textContent = w.s;
                btn.onclick = () => {
                    if (btn.classList.contains('bg-green-600') || !selectedPre || isProcessing) return;
                    if (selectedPre.dataset.id === w.full) {
                        isProcessing = true; AudioEngine.correct();
                        btn.classList.add('bg-green-600', 'border-green-400');
                        selectedPre.classList.remove('selected');
                        selectedPre.classList.add('bg-green-600', 'border-green-400');
                        score += 100; matchCount++;
                        showWordMeaning(w);
                        addToFoundList(w.full);
                        setTimeout(() => { checkLevelComplete(matchCount, 5); isProcessing = false; }, 500);
                        selectedPre = null;
                    } else {
                        AudioEngine.wrong(); btn.classList.add('shake');
                        setTimeout(() => btn.classList.remove('shake'), 400);
                        selectedPre.classList.remove('selected'); selectedPre = null;
                    }
                    updateUI();
                };
                rightCol.appendChild(btn);
            });
        }

        function initBubbleMode() {
            let bubbleMatches = 0;
            let firstBubble = null;
            const arena = document.getElementById('bubble-arena');
            document.getElementById('bubble-container').classList.remove('hidden');
            arena.innerHTML = '';
            
            const parts = [];
            levelWords.forEach(w => {
                parts.push({ text: w.p, id: w.full, type: 'prefix' });
                parts.push({ text: w.s, id: w.full, type: 'suffix' });
            });
            parts.sort(() => Math.random() - 0.5);

            parts.forEach((p, i) => {
                const b = document.createElement('div');
                b.className = 'bubble bg-indigo-500/60 text-white font-bold';
                b.textContent = p.text;
                b.style.width = '85px'; b.style.height = '85px';
                b.style.left = (10 + (i % 3) * 28 + Math.random() * 5) + '%';
                b.style.top = (10 + Math.floor(i / 3) * 18 + Math.random() * 5) + '%';
                
                b.onclick = () => {
                    if (b.classList.contains('opacity-0') || isProcessing) return;
                    if (!firstBubble) {
                        if (p.type !== 'prefix') { AudioEngine.wrong(); b.classList.add('shake'); setTimeout(() => b.classList.remove('shake'), 400); return; }
                        AudioEngine.tap(); firstBubble = { el: b, id: p.id };
                        b.classList.add('active-selection', 'bg-indigo-600');
                    } else if (firstBubble.el === b) {
                        firstBubble = null; b.classList.remove('active-selection', 'bg-indigo-600');
                    } else {
                        if (firstBubble.id === p.id && p.type === 'suffix') {
                            isProcessing = true; AudioEngine.pop(); AudioEngine.correct();
                            b.classList.add('opacity-0', 'scale-150');
                            firstBubble.el.classList.add('opacity-0', 'scale-150');
                            addToFoundList(p.id);
                            score += 100; bubbleMatches++;
                            showWordMeaning(levelWords.find(w => w.full === p.id));
                            setTimeout(() => { checkLevelComplete(bubbleMatches, 5); isProcessing = false; }, 500);
                        } else {
                            AudioEngine.wrong(); firstBubble.el.classList.remove('active-selection', 'bg-indigo-600');
                            b.classList.add('shake'); setTimeout(() => b.classList.remove('shake'), 400);
                        }
                        firstBubble = null; updateUI();
                    }
                };
                arena.appendChild(b);
            });
        }

        function initGridMode() {
            const container = document.getElementById('grid-container');
            container.classList.remove('hidden'); container.innerHTML = '';
            let gridMatches = 0; let selected = null;
            const parts = [];
            levelWords.forEach(w => {
                parts.push({ text: w.p, id: w.full, type: 'p' });
                parts.push({ text: w.s, id: w.full, type: 's' });
            });
            parts.sort(() => Math.random() - 0.5);
            parts.forEach(p => {
                const btn = document.createElement('div');
                btn.className = 'word-btn bg-slate-800 border-2 border-slate-700 text-xs aspect-square';
                btn.textContent = p.text;
                btn.onclick = () => {
                    if (btn.classList.contains('bg-green-600') || isProcessing) return;
                    AudioEngine.tap();
                    if (!selected) { selected = { el: btn, data: p }; btn.classList.add('selected'); }
                    else if (selected.el === btn) { selected = null; btn.classList.remove('selected'); }
                    else {
                        if (selected.data.id === p.id && selected.data.type !== p.type) {
                            isProcessing = true; AudioEngine.correct();
                            btn.classList.add('bg-green-600', 'border-green-400');
                            selected.el.classList.add('bg-green-600', 'border-green-400');
                            addToFoundList(p.id);
                            score += 100; gridMatches++;
                            showWordMeaning(levelWords.find(w => w.full === p.id));
                            setTimeout(() => { checkLevelComplete(gridMatches, 5); isProcessing = false; }, 500);
                        } else {
                            AudioEngine.wrong(); btn.classList.add('shake');
                            setTimeout(() => btn.classList.remove('shake'), 400);
                            selected.el.classList.remove('selected');
                        }
                        selected = null; updateUI();
                    }
                };
                container.appendChild(btn);
            });
        }

        function checkLevelComplete(current, total) {
            document.getElementById('progress-bar').style.width = (current / total * 100) + '%';
            if (current >= total) {
                AudioEngine.levelComplete();
                setTimeout(() => {
                    document.getElementById('completed-lvl').textContent = currentLevel;
                    document.getElementById('overlay').classList.remove('hidden');
                }, 800);
            }
        }

        function showWordMeaning(word) {
            const box = document.getElementById('meaning-box'); box.style.opacity = '1';
            document.getElementById('word-title').textContent = word.full;
            document.getElementById('word-meaning').textContent = "A compound word formed from " + word.p + " and " + word.s + ".";
        }

        function startNextLevel() { document.getElementById('overlay').classList.add('hidden'); currentLevel++; setupLevel(); }
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function updateUI() { document.getElementById('score-display').textContent = score; }
        
        window.onload = () => { processCSV(); setupLevel(); document.body.onclick = () => AudioEngine.init(); };
    </script>
</body>
</html>
